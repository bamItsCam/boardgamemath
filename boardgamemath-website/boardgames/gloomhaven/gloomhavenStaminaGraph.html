<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .handCardBar {
        fill: steelblue;
    }
    .discardCardBar {
        fill: skyblue;
    }
    .revivingEtherLine {
        fill: purple;
    }
    .revivingEtherText {
        fill: purple;
    }
    .shortRestLine {
        fill: gold;
    }
    .shortRestText {
        fill: gold;
    }
    .longRestLine {
        fill: silver;
    }

    .axis text {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .x.axis path {
        display: none;
    }
</style>
<section style="display:block;">
    Character: <select onchange="changeCharacter(this)"></select>
</section>
<svg class="chart"></svg>
<script src="../../website/d3/d3.min.js"></script>
<script type="text/javascript">

    var MAX_ROUNDS = 40;
    var MAX_HAND_LIMIT = 12;
    var characters;
    var selectedCharacter;
    var rounds;

    initCharacters();
    initRounds();
    initChart();
    updateRounds();

    function Character(name, handLimit, revivingEtherAvailable) {
        this.name = name;
        this.handLimit = handLimit;
        this.revivingEtherAvailable = revivingEtherAvailable;
    }

    function initCharacters() {
        characters = [
            new Character("Brute", 10, false),
            new Character("Cragheart", 11, false),
            new Character("Mindthief", 10, false),
            new Character("Scoundrel", 9, false),
            new Character("Spellweaver", 8, true),
            new Character("Tinkerer", 12, false)
        ];
        selectedCharacter = characters[0];
        d3.select("select").selectAll("option").data(characters)
                .enter().append("option").attr("value",function(character){ return character;})
                .text(function(character){
                    return character.name + " (" + character.handLimit + " cards)";
                });
    }

    function changeCharacter(t) {
        selectedCharacter = characters[t.selectedIndex];
        updateRounds();
    }

    function Round(number) {
        this.number = number;
        this.handCardSize = number;
        this.discardCardSize = 0;

        this.loseCard1 = false;
        this.loseCard2 = false;
        this.revivingEther = false;
        this.shortRest = false;
        this.longRest = false;
    }

    function initRounds() {
        rounds = new Array(MAX_ROUNDS);
        for (var i = 0; i < rounds.length; i++) {
            rounds[i] = new Round(i + 1);
        }
    }

    function updateRounds() {
        var handCardSize = selectedCharacter.handLimit;
        var discardCardSize = 0;
        var revivingEtherAvailable = selectedCharacter.revivingEtherAvailable;
        for (var i = 0; i < rounds.length; i++) {
            var round = rounds[i];
            if (handCardSize < 2) {
                if (discardCardSize < 2 || (discardCardSize === 2 && handCardSize === 0)) { // Exhausted
                    handCardSize = 0;
                    discardCardSize = 0;
                    round.shortRest = false;
                    round.longRest = false;
                } else if (round.longRest) { // Long rest announced
                    round.shortRest = false;
                } else { // Automatic short rest
                    handCardSize += discardCardSize - 1;
                    discardCardSize = 0;
                    round.shortRest = true;
                }
            } else {
                round.shortRest = false;
            }
            round.handCardSize = handCardSize;
            round.discardCardSize = discardCardSize;
            round.revivingEther = false;
            if (round.longRest) { // Long rest
                handCardSize += discardCardSize - 1;
                discardCardSize = 0;
            } else if (handCardSize >= 2) { // Normal play
                handCardSize -= 2;
                discardCardSize += 2;
                if (revivingEtherAvailable
                        && (discardCardSize < 2 || (discardCardSize === 2 && handCardSize === 0))) {
                    round.revivingEther = true;
                    handCardSize += (selectedCharacter.handLimit - handCardSize - discardCardSize) - 1;
                    revivingEtherAvailable = false;
                }
            }
        }
        updateChart();
    }

    function initChart() {
        margin = {top: 20, right: 30, bottom: 40, left: 40};
        width = 960 - margin.left - margin.right;
        height = 300 - margin.top - margin.bottom;

        chart = d3.select(".chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        xRange = d3.scaleBand()
                .domain(d3.range(1, MAX_ROUNDS + 1))
                .range([0, width])
                .padding(0.1);
        chart.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom().scale(xRange));
        chart.append("text")
                .attr("transform",
                        "translate(" + (width / 2) + " ," + (height + margin.top + 20) + ")")
                .style("text-anchor", "middle")
                .text("Rounds");

        yRange = d3.scaleLinear()
                .domain([0, MAX_HAND_LIMIT])
                .range([height, 0]);
        chart.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft().scale(yRange));
        chart.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Hand / Discarded cards");

        var roundBar = chart.selectAll(".roundBar")
                .data(rounds)
                .enter().append("g")
                .attr("class", "roundBar");

        handCardBar = roundBar.append("rect")
                .attr("class", "handCardBar")
                .attr("x", function (round) {
                    return xRange(round.number);
                })
                .attr("width", xRange.bandwidth());
        discardCardBar = roundBar.append("rect")
                .attr("class", "discardCardBar")
                .attr("x", function (round) {
                    return xRange(round.number);
                })
                .attr("width", xRange.bandwidth());
        revivingEtherLine = roundBar.append("rect")
                .attr("class", "revivingEtherLine")
                .attr("x", function (round) {
                    return xRange(round.number + 1) - 2;
                })
                .attr("width", 4);
        revivingEtherText = roundBar.append("text")
                .attr("class", "revivingEtherText")
                .attr("x", function (round) {
                    return xRange(round.number + 1);
                })
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("reviving ether");
        shortRestLine = roundBar.append("rect")
                .attr("class", "shortRestLine")
                .attr("x", function (round) {
                    return xRange(round.number) - 2;
                })
                .attr("width", 4);
        shortRestText = roundBar.append("text")
                .attr("class", "shortRestText")
                .attr("x", function (round) {
                    return xRange(round.number);
                })
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("short rest");
        longRestLine = roundBar.append("rect")
                .attr("class", "longRestLine")
                .attr("x", function (round) {
                    return xRange(round.number);
                })
                .attr("width", xRange.bandwidth());
    }

    function updateChart() {
        handCardBar
                .attr("y", function (round) {
                    return yRange(round.handCardSize);
                })
                .attr("height", function (round) {
                    return height - yRange(round.handCardSize);
                });
        discardCardBar
                .attr("y", function (round) {
                    return yRange(round.discardCardSize + round.handCardSize);
                })
                .attr("height", function (round) {
                    return height - yRange(round.discardCardSize);
                });
        revivingEtherLine
                .attr("visibility", function (round) {
                    return round.revivingEther ? "visible" : "hidden";
                })
                .attr("y", function (round) {
                    return yRange(selectedCharacter.handLimit);
                })
                .attr("height", function (round) {
                    return height - yRange(selectedCharacter.handLimit);
                });
        revivingEtherText
                .attr("visibility", function (round) {
                    return round.revivingEther ? "visible" : "hidden";
                })
                .attr("y", function (round) {
                    return yRange(selectedCharacter.handLimit + 1);
                });
        shortRestLine
                .attr("visibility", function (round) {
                    return round.shortRest ? "visible" : "hidden";
                })
                .attr("y", function (round) {
                    return yRange(round.discardCardSize + round.handCardSize + 1);
                })
                .attr("height", function (round) {
                    return height - yRange(round.discardCardSize + round.handCardSize + 1);
                });
        shortRestText
                .attr("visibility", function (round) {
                    return round.shortRest ? "visible" : "hidden";
                })
                .attr("y", function (round) {
                    return yRange(round.discardCardSize + round.handCardSize + 2);
                });
        longRestLine
                .attr("visibility", function (round) {
                    return round.longRest ? "visible" : "hidden";
                })
                .attr("y", function (round) {
                    return yRange(round.discardCardSize + round.handCardSize + 1);
                })
                .attr("height", function (round) {
                    return height - yRange(round.discardCardSize + round.handCardSize);
                });

    }

</script>
